name: App CI

on:
  push:
    branches:
    - main
    tags:
    - 'v*.*.*'

env:
  VERSION: ${{ github.ref_type == 'tag' && github.ref_name || github.sha }}
  BUCKET_NAME: ${{ github.ref_type == 'tag' && secrets.PROD_BUCKET || secrets.DEV_BUCKET }}
  API_URL: ${{ github.ref_type == 'tag' && vars.PROD_API_URL || vars.DEV_API_URL }}
  WEBSITE_URL: ${{ github.ref_type == 'tag' && vars.PROD_WEBSITE_URL || vars.DEV_WEBSITE_URL }}

jobs:

  release:
    runs-on: ${{ matrix.platform.os }}

    strategy:
        matrix:
          platform:
          - os: windows-latest
            extention: exe
          # - os: macos-latest
          #   extention: dmg

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Install Node.js, NPM and Yarn
      uses: actions/setup-node@v1
      with:
        node-version: 18.12.1

    - name: Compile Electron App
      uses: x6Pnda/action-electron-compiler@v1.0.1
      with:
        args: --set-product-version ${{ env.VERSION }}

    - id: auth
      name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: '${{ secrets.GCLOUD_SERVICE_ACCOUNT }}'

    - id: upload
      uses: google-github-actions/upload-cloud-storage@v2
      with:
        path: 'out/make/squirrel.windows/x64/3walls-app-${{ env.VERSION }} Setup.exe'
        destination: '${{ env.BUCKET_NAME }}/lesson-viewer/v1/${{ env.VERSION }}.${{ matrix.platform.extention }}'

    - name: Deploy Stage
      uses: fjogeleit/http-request-action@v1
      with:
        url: '${{ env.API_URL }}/api/v2/viewer/version?version=${{ env.VERSION }}'
        method: 'POST'
